function devLogAdd(c){$("#devLog").append($("<div />",{text:c}))}function devLogSet(c){$("#devLog").html($("<div />",{text:c}))}var incrementKey=function(c,d){d in c?c[d]++:c[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(c){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,g){c.unbind(g)});WorkQueue.gracefullyResume()}
function progress(){var c=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(c),g=$("<progress />");g.append(c);var k=1,b=0,r=function(){d.css("width",sprintf("%s%%",Math.floor(b/k*100)));g.attr({value:b,max:k})},f={element:g,value:function(c){b=c;r();return f},max:function(b){k=b;r();return f}};return f}
function proportion(c,d){return c/d/(boardWidth/boardHeight)}function scaleScreenToWorld(c){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return c*d}function scaleWorldToScreen(c){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return c/d}function screenToWorld(c,d){var g=scaleScreenToWorld(c)+viewboxX,k=scaleScreenToWorld(d)+viewboxY;return{x:g,y:k}}
function worldToScreen(c,d){var g=scaleWorldToScreen(c-viewboxX),k=scaleWorldToScreen(d-viewboxY);return{x:g,y:k}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(c){return!1}}
function registerPositionHandlers(c,d,g,k){var b=!1,r=function(b,c){var f=[b.x-10,b.y-10,b.x+10,b.y+10],a=!0;_.each(Modes.canvasInteractables,function(n,d){_.each(n,function(n){void 0!=n&&c in n&&(n.activated||intersectRect(f,n.getBounds()))&&(a=a&&n[c](b))})});return a},f=function(b,c){return{shift:b.shiftKey,ctrl:b.ctrlKey,alt:b.altKey,eraser:c}};$.each(c,function(c,w){var m=$(w);m.css({"touch-action":"none"});var a=!1,n={},v=function(e){var h=e.originalEvent.pointerId,b="pen"==e.originalEvent.pointerType&&
5==e.originalEvent.button,c=m.offset(),l=e.pageX-c.left,c=e.pageY-c.top,q=e.originalEvent.pressure||.5,f=screenToWorld(l,c),d=n[h]||{pointerId:h,pointerType:e.originalEvent.pointerType,eraser:b,points:[]};d.points.push({x:f.x,y:f.y,screenX:l,screenY:c,z:q});d.eraser=d.eraser||b;n[h]=d;1<_.size(n)&&(0==a&&_.each(n,function(e){e.points=[_.last(e.points)]}),a=!0);return{pointerType:e.pointerType,eraser:d.eraser,x:l,y:c,z:q,worldPos:f}},t=function(e){var h=e.originalEvent.pointerId,c="pen"==e.originalEvent.pointerType&&
5==e.originalEvent.button,l=m.offset(),q=e.pageX-l.left,l=e.pageY-l.top,d=e.originalEvent.pressure||.5,f=screenToWorld(q,l);delete n[h];a&&0==_.size(n)&&(b=a=!1);return{pointerType:e.pointerType,eraser:c,x:q,y:l,z:d,worldPos:f}};if(detectPointerEvents()){var q=_.throttle(function(){if(1<_.size(n)){takeControlOfViewbox();var e=_.map(_.filter(n,function(e){return 0<_.size(e.points)}),function(e){var h=_.first(e.points);e=_.last(e.points);return[h,e]});n={};var h=_.meanBy(e,function(e){return e[0].x-
e[1].x}),a=_.meanBy(e,function(e){return e[0].y-e[1].y});Pan.translate(scaleWorldToScreen(h),scaleWorldToScreen(a));var h=_.min(_.map(e,function(e){return e[0].y})),b=_.max(_.map(e,function(e){return e[0].y})),a=_.min(_.map(e,function(e){return e[0].x})),c=_.max(_.map(e,function(e){return e[0].x})),h=b-h,a=c-a,c=_.min(_.map(e,function(e){return e[1].y})),b=_.max(_.map(e,function(e){return e[1].y})),l=_.min(_.map(e,function(e){return e[1].x})),e=(_.max(_.map(e,function(e){return e[1].x}))-l+(b-c))/
2;Zoom.scale((a+h)/2/e)}},25);m.bind("pointerdown",function(e){var h=v(e);e.preventDefault();WorkQueue.pause();1!=_.size(n)||a||(b=!0,r(h.worldPos,"down")&&d(h.x,h.y,h.z,h.worldPos,f(e,h.eraser)))});m.bind("pointermove",function(e){var h=v(e);e.preventDefault();(e.originalEvent.pointerType==e.POINTER_TYPE_TOUCH||"touch"==e.originalEvent.pointerType&&1<_.size(n))&&q();1!=_.size(n)||a||r(h.worldPos,"move")&&b&&g(h.x,h.y,h.z,h.worldPos,f(e,h.eraser))});m.bind("pointerup",function(e){var h=t(e);WorkQueue.gracefullyResume();
e.preventDefault();r(h.worldPos,"up")&&b&&!a&&k(h.x,h.y,h.z,h.worldPos,f(e,h.eraser));b=!1;Modes.finishInteractableStates()});var z=function(e){t(e);WorkQueue.gracefullyResume();e.preventDefault();if(b){var h=e.offsetX;e=e.offsetY;n={};WorkQueue.gracefullyResume();e=screenToWorld(h,e);h=e.x;e=e.y;h<viewboxX?(takeControlOfViewbox(),Extend.left()):h>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):e<viewboxY?(takeControlOfViewbox(),Extend.up()):e>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),
Extend.down());b=!1;Modes.finishInteractableStates()}b=!1;Modes.finishInteractableStates()};m.bind("pointerout",z);m.bind("pointerleave",z);m.bind("pointercancel",z)}else{m.bind("mousedown",function(e){WorkQueue.pause();var h=m.offset();b=!0;var a=e.pageX-h.left,h=e.pageY-h.top,n=screenToWorld(a,h);r(n,"down")&&d(a,h,.5,n,f(e));e.preventDefault()});m.bind("mousemove",function(e){var h=m.offset();e.preventDefault();var a=e.pageX-h.left,h=e.pageY-h.top,n=screenToWorld(a,h);r(n,"move")&&b&&g(a,h,.5,
n,f(e))});m.bind("mouseup",function(e){WorkQueue.gracefullyResume();e.preventDefault();var h=m.offset(),a=e.pageX-h.left,h=e.pageY-h.top,n=screenToWorld(a,h);r(n,"up")&&b&&k(a,h,.5,n,f(e));b=!1;Modes.finishInteractableStates()});var x=function(e,h){WorkQueue.gracefullyResume();var a=screenToWorld(e,h),n=a.x,a=a.y;n<viewboxX?(takeControlOfViewbox(),Extend.left()):n>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):a<viewboxY?(takeControlOfViewbox(),Extend.up()):a>=viewboxY+viewboxHeight&&
(takeControlOfViewbox(),Extend.down());b=!1};m.bind("mouseout",function(e){WorkQueue.gracefullyResume();e.preventDefault();b&&x(e.offsetX,e.offsetY);b=!1;Modes.finishInteractableStates()});var u,y=function(e){return{x:average(_.map(e,"x")),y:average(_.map(e,"y"))}},l=function(e){var h=[],a=m.offset();$.each(e,function(e,b){h.push({x:b.pageX-a.left,y:b.pageY-a.top,identifier:b.identifier})});return h};m.bind("touchstart",function(e){WorkQueue.pause();e.preventDefault();var h=l(e.originalEvent.touches);
if(1==h.length){var h=h[0],a=screenToWorld(h.x,h.y);b=!0;r(a,"down")&&d(h.x,h.y,.5,a,f(e))}else u=y(h)});m.bind("touchmove",function(e){e.preventDefault();var h=l(e.originalEvent.touches);switch(h.length){case 0:break;case 1:var h=h[0],a=screenToWorld(h.x,h.y);r(a,"move")&&b&&g(h.x,h.y,.5,a,f(e));break;default:e=y(h),h=e.x-u.x,a=e.y-u.y,u=e,takeControlOfViewbox(),Pan.translate(-1*h,-1*a)}});m.bind("touchend",function(e){WorkQueue.gracefullyResume();e.preventDefault();var h=m.offset(),a=e.originalEvent.changedTouches[0],
n=a.pageX-h.left,h=a.pageY-h.top,a=screenToWorld(n,h);r(a,"up")&&b&&(0>n||0>h||n>boardWidth||h>boardHeight?x(n,h):k(n,h,.5,a,f(e)));b=!1;Modes.finishInteractableStates()});var A=1;m.bind("gesturechange",function(e){WorkQueue.pause();e.preventDefault();b=!1;e=e.originalEvent.scale;takeControlOfViewbox();Zoom.scale(A/e);A=e});m.bind("gestureend",function(){WorkQueue.gracefullyResume();A=1})}});return function(c){b=c}}
function aspectConstrainedDimensions(c,d){var g=boardHeight/boardWidth,k={height:d,width:c};d/c>g?k.height=c*g:k.width=d/g;return k}
function aspectConstrainedRect(c,d,g){var k=boardHeight/boardWidth,b={left:c.left,top:c.top,right:c.right,bottom:c.bottom,width:c.width,height:c.height};c.height/c.width>k?(b.height=c.width*k,g&&(d=c.height-b.height,"center"==g?b.top+=d/2:"bottom"==g&&(b.top+=d))):(b.width=c.height/k,d&&(g=c.width-b.width,"center"==d?b.left+=g/2:"right"==d&&(b.left+=g)));b.right=b.left+b.width;b.bottom=b.top+b.height;return b}
function copyBuffer(c){var d=document.createElement("canvas");d.width=c.width;d.height=c.height;d.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,c.width,c.height);return d}function intersectRect(c,d){return"undefined"!=typeof c&&"undefined"!=typeof d?!(d[0]>c[2]||d[2]<c[0]||d[1]>c[3]||d[3]<c[1]):!1}function overlapRect(c,d){return intersectRect(c,d)?(Math.max(c[0],d[0])-Math.min(c[2],d[2]))*(Math.max(c[1],d[1])-Math.min(c[3],d[3])):0}
function rectFromTwoPoints(c,d,g){g=g||0;var k,b,r;c.x<d.x?(k=c.x,r=d.x):(k=d.x,r=c.x);c.y<d.y?(b=c.y,c=d.y):(b=d.y,c=c.y);d=r-k;var f=c-b;d<g&&(r+=g-d,d=r-k);f<g&&(c+=g-f,f=c-b);return{left:k,top:b,right:r,bottom:c,width:d,height:f}}function updateMarquee(c,d,g){d=rectFromTwoPoints(d,g);g=$("#selectionAdorner");jQuery.contains(g,c)||g.append(c);c.is(":visible")||c.show();c.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(c){var d=c.x,g=c.y;0>c.x&&(d=0);c.x>boardWidth&&(d=boardWidth);0>c.y&&(g=0);c.y>boardHeight&&(g=boardHeight);return{x:d,y:g}}
var bounceButton=function(c){var d=$(c);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(c){var d=void 0;return{activated:!1,rehome:function(c){},down:function(c){return!1},move:function(c){return!1},up:function(d){var k=Modes.select.handlesAtZoom();d=d.x-c.x;if(d<k)c.getState().paused?c.play():c.pause();else if(d>c.width-k)c.muted(!c.muted());else{var b=c.getState();c.seek((d-k)/(c.width-2*k)*b.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(g){if(c.identity in boardContent.videos){var k=Modes.select.handlesAtZoom();d=[c.bounds[0],c.bounds[3],c.bounds[2],c.bounds[3]+k];var k=worldToScreen(d[0],d[1]),b=worldToScreen(d[2],d[3]),r=b.x-k.x,f=b.y-k.y,p=c.getState();g.globalAlpha=1;g.setLineDash([]);g.strokeStyle="black";g.font=sprintf("%spx FontAwesome",f);g.fillStyle="white";g.fillRect(k.x,k.y,f,f);g.fillStyle="black";p.paused?g.fillText("\uf04b",k.x,b.y):g.fillText("\uf04c",k.x,b.y);var w=k.x+f,m=
r-f;g.fillStyle="black";g.fillRect(w,k.y,m,f);g.fillStyle="blue";m*=p.currentTime/p.duration;g.fillRect(w,k.y,m,f);r=k.x+(r-f);g.fillStyle="white";g.fillRect(r,k.y,f,f);g.fillStyle="black";p.muted?g.fillText("\uf0f3",r,b.y):g.fillText("\uf1f6",r,b.y)}}}},Modes=function(){var c=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(b,d){c();$(b).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},g={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;c()},deactivate:function(){c();unregisterPositionHandlers(board)}},k=function(b,c){b in Modes.canvasInteractables||(Modes.canvasInteractables[b]=[]);Modes.canvasInteractables[b].push(c)};$(function(){var b={opacity:1};(new TWEEN.Tween(b)).delay(1E3).to({opacity:.3},1E3);var c=Modes.select.handlesAtZoom(),d=function(){var m=void 0;return{getBounds:function(){return m},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!d.activated){var b=Modes.select.handlesAtZoom(),c=a.x+b/2;m=[c-b/2,a.y-b,c+b/2,a.y]}},down:function(a){d.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){d.activated&&(d.bounds=[a.x-c,a.y,a.x+c,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){d.activated=!1;Modes.select.dragging=!1},up:function(a){d.deactivate();var b=
batchTransform(),c=a.x-Modes.select.marqueeWorldOrigin.x,t=a.y-Modes.select.marqueeWorldOrigin.y;b.xTranslate=c;b.yTranslate=t;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(b.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=
c;a.doc.position.y+=t;a.doc.invalidateBounds()});sendStanza(b);registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(m){var c=worldToScreen(m[0],m[1]),d=worldToScreen(m[2],m[3]).x-c.x,f=c.x,c=c.y;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(f,c,d,d);a.strokeRect(f,c,d,d);a.font=sprintf("%spx FontAwesome",d);a.fillStyle="black";a.fillText("\uf047",f,c+d-4)}}}}(),p=function(){var d=
void 0;return{getBounds:function(){return d},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!p.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=a.y;d=[c,a,c+b,a+b]}},down:function(a){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;p.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};p.rehome(a);blit();return!1},move:function(a){if(p.activated){d=[a.x-c,d[1],a.x+c,d[3]];var b=Modes.select.totalSelectedBounds();
Modes.select.offset={x:a.x,y:b.y+(a.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;p.activated=!1;Modes.select.resizing=!1},up:function(a){p.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds();b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=b.xScale;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);
b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,c){Modes.text.echoesToDisregard[c]=!0;var d=a.doc.documentRange();a.doc.select(d.start,d.end);Modes.text.scaleEditor(a.doc,b.xScale);a.doc.select(0,0);a.doc.width(a.doc.width()*b.xScale);a.doc.invalidateBounds()});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(a){if(d){var c=worldToScreen(d[0],d[1]),f=worldToScreen(d[2],
d[3]).x-c.x,t=f/10,q=-1*f;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(c.x,c.y);a.rotate(90*Math.PI/180);a.fillRect(0,q,f,f);a.strokeRect(0,q,f,f);a.font=sprintf("%spx FontAwesome",f);a.fillStyle="black";a.fillText("\uf0b2",t,-1*t)}}}}(),g=function(){var d=void 0;return{activated:!1,getBounds:function(){return d},rehome:function(a){if(!g.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=a.y2;d=[c,a-b,c+b,a]}},down:function(a){g.activated=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();console.log("Free transform down");return!1},move:function(a){g.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),g.bounds=[a.x-c,a.y-c,a.x+c,a.y+c],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){g.activated=!1;Modes.select.resizing=!1},up:function(a){g.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds(),
d=c.y2-c.y,f=a.y-c.y;b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=f/d;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*b.xScale,Modes.text.minimumWidth/scale()));a.doc.invalidateBounds();0<a.doc.save().length&&sendRichText(a)});registerTracker(b.identity,
function(){Progress.call("onSelectionChanged");blit()});console.log("Free transform up");sendStanza(b);blit();return!1},render:function(a){if(d){var c=worldToScreen(d[0],d[1]),f=worldToScreen(d[2],d[3]).x-c.x,t=f/10,q=-1*f;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(c.x,c.y);a.rotate(90*Math.PI/180);a.fillRect(0,q,f,f);a.strokeRect(0,q,f,f);a.font=sprintf("%spx FontAwesome",f);a.fillStyle="black";a.fillText("\uf065",t,-1*t)}}}}();
k("manualMove",d);k("resizeFree",g);k("resizeAspectLocked",p);Progress.textBoundsChanged.selectionHandles=function(b,a){if(b in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();d.rehome(c);g.rehome(c);p.rehome(c)}};Progress.onSelectionChanged.selectionHandles=function(){var c=Modes.select.totalSelectedBounds();Infinity==c.x?b.opacity=0:(b.opacity=1,d.rehome(c),g.rehome(c),p.rehome(c))}});return{pushCanvasInteractable:k,clearCanvasInteractables:function(b){Modes.canvasInteractables[b]=
[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(b){return _.map(b,function(b){b=_.clone(b);b.bounds=b.getBounds();return b})})},currentMode:g,none:g,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(b){_.forEach(Modes.canvasInteractables[b],function(b){void 0!=b&&"deactivate"in b&&b.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var b=
function(){},g,f,p,k,m,a,n,v,t,q,z,x=function(e,a){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[e.x,e.y,e.x,e.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",requestedWidth:b,width:b,height:0,x:e.x,y:e.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(a);return b},u=function(e){return function(){var a=!1;_.each(boardContent.multiWordTexts,
function(b){if(b.doc.isActive){a=!0;var c=b.doc.selectedRange();carota.runs.nextInsertFormatting={};c.setFormatting(e,!0!==c.getFormatting()[e]);0<b.doc.save().length&&sendRichText(b)}});if(!a){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var b=carota.runs.nextInsertFormatting[e]=!carota.runs.nextInsertFormatting[e];$(sprintf(".font%sSelector",_.capitalize(e))).toggleClass("active",b)}}},y=function(e,a){return function(){var b=!1;a=a||$(this).val();_.each(boardContent.multiWordTexts,
function(c){c.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},c.doc.selectedRange().setFormatting(e,a),0<c.doc.save().length&&sendRichText(c))});b||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[e]=a)}},l=function(e,a){var b=e.selectedRange(),c=0,d=[],l=carota.runs.defaultFormatting.size;e.runs(function(a){a=_.size(a.text);a=c+a;e.select(c,a,!0);var b=e.selectedRange().getFormatting().size||l;_.each(_.range(c,a),function(){d.push(b)});
c=a;l=b},e.range(0,b.end));d=d.reverse();c=b.start;e.runs(function(b){b=c+b.text.length;e.select(c,b,!0);e.selectedRange().setFormatting("size",d[c]*a);c=b},e.range(b.start,b.end));e.select(b.start,b.end,!0)},A=function(e){return function(){_.each(boardContent.multiWordTexts,function(a){a=a.doc;a.isActive&&l(a,e)})}};$(function(){k=$(".fontBoldSelector");m=$(".fontItalicSelector");a=$(".fontUnderlineSelector");t=$("#textDropdowns");v=$("#fontOptions");g=$("#fontFamilySelector");f=$("#fontSizeSelector");
p=$("#fontColorSelector");q=$("#fontLarger");z=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");n=$("#presetFullscreen");$("#presetCenterOnScreen");var e=g.find(".fontFamilyOption").clone(),b=f.find(".fontSizeOption").clone(),c=p.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){g.append(e.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(e){f.append(b.clone().attr("value",e).text(e))});
Colors.getAllNamedColors().map(function(e){p.append(c.clone().attr("value",e.rgb).text(e.name))});q.on("click",A(1.2));z.click(A(.8));k.click(u("bold"));m.click(u("italic"));a.click(u("underline"));var d={red:"#ff0000",blue:"#0000ff",black:"#000000"};_.each(["red","blue","black"],function(e){$(sprintf("#%sText",e)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");y("color",[d[e],255])()})});n.click(function(e){return function(){_.each(boardContent.multiWordTexts,
function(a){if(a.doc.isActive){switch(e){case "runToEdge":var b=screenToWorld(boardWidth,0);a.doc.width(b.x+viewboxX-a.x);break;case "fitToText":a.doc.width(a.doc.frame.actualWidth());break;case "widen":a.doc.width(1.6*a.doc.frame.actualWidth());break;case "narrow":a.doc.width(.6*a.doc.frame.actualWidth());break;case "centerOnScreen":a.doc.width(screenToWorld(boardWidth,0).x);a.doc.selectedRange().setFormatting("align","center");a.doc.position.x=viewboxX;break;case "fullscreen":a.doc.position.x=viewboxX,
a.doc.position.y=viewboxY,a.doc.width(screenToWorld(boardWidth,0).x)}a.doc.contentChanged.fire()}})}}("fullscreen"));v.click(function(){t.toggle()});$("#closeTextDialog").click(function(){t.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},
getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var b=a.doc.selectedRange();return{identity:a.identity,start:b.start,end:b.end,text:b.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){console.log("Textbox",a.identity,a.doc.width());a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var b=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,
function(c){c.identity in b&&a(c)})},scaleEditor:l,scrollToCursor:function(a){var b=a.bounds,c=a.doc.selectedRange().start;a=a.doc.getCaretCoords(c);var c=Math.floor(a.t/a.h),d=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var c=Math.min(c,Math.max(0,d-2))*a.h,d=Math.max(b[2]-b[0],scaleWorldToScreen(10*a.h)),l=d/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(b[0],b[1]-c+a.t,d,l)}else b=Math.max(0,
Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(b[1]-viewboxY))/a.h)-4))*a.h,0!=b&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+b,viewboxWidth,viewboxHeight)},editorFor:function(e){var c=boardContent.multiWordTexts[e.identity];c||(c=boardContent.multiWordTexts[e.identity]=e);if(!c.doc){var d=e.author==UserSettings.getUsername();c.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",e.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],d?blit:b,e);d&&(d=_.debounce(function(){Modes.text.scrollToCursor(c);
var a=boardContent.multiWordTexts[c.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(c.bounds)},1E3),c.doc.contentChanged(d),c.doc.selectionChanged(function(b,e){if(0<c.doc.save().length){var d=b();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var l=[$("#blackText"),$("#redText"),$("#blueText")],f=function(a,b){var e=1==d[b];e&&(carota.runs.nextInsertFormatting[b]=e);a.toggleClass("active",e)},q=function(a,
b,e){var c=_.isEqual(d[b],e);b in d&&c&&(carota.runs.nextInsertFormatting[b]=e);a.toggleClass("active",c)};f(k,"bold");f(m,"italic");f(a,"underline");q(l[0],"color",["#000000",255]);q(l[1],"color",["#ff0000",255]);q(l[2],"color",["#0000ff",255]);e&&Modes.text.scrollToCursor(c)}}))}c.doc.position={x:e.x,y:e.y};c.doc.width(e.width);return c},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,b,c,d){var l=UserSettings.getUsername(),f=[d.x-10,d.y-10,d.x+10,d.y+10];
a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,f)&&a.author==l});return 0<a.length?a[0]:!1},contextFor:function(a,b){var c={x:b.x-a.position.x,y:b.y-a.position.y};return{node:a.byCoordinate(c.x,c.y),relativePos:c}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,function(a,b,c,e){if(a=
Modes.text.editorAt(a,b,c,e).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,e).node)},function(a,b,e,c){(a=Modes.text.editorAt(a,b,e,c).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,c).node)},function(b,c,d,l){var f=Date.now(),q=Modes.text.editorAt(b,c,d,l);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==q.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();
q?(b=q.doc,l=Modes.text.contextFor(b,l),500>=f-a?b.dblclickHandler(l.node):b.mouseupHandler(l.node),a=f,l={multiWordTexts:{}},l.multiWordTexts[q.identity]=q,Modes.select.setSelection(l)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},b=x(l,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,
size:carota.runs.defaultFormatting.size/scale()}]),f=b.doc,f.select(0,1),boardContent.multiWordTexts[b.identity]=b,l={multiWordTexts:{}},l.multiWordTexts[b.identity]=boardContent.multiWordTexts[b.identity],Modes.select.setSelection(l),q=b,l=f.byOrdinal(0),f.mousedownHandler(l),f.mouseupHandler(l));q.doc.invalidateBounds();q.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(q);Progress.call("onSelectionChanged",[Modes.select.selected])})},
handleDrop:function(a,b,c){if(0<a.length){a=carota.html.parse(a,{});console.log("newRuns:",a);b=screenToWorld(b,c);Modes.text.activate();Date.now();Modes.select.clearSelection();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var d=x(b,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,
size:carota.runs.defaultFormatting.size/scale()}]);b=d.doc;b.select(0,1);boardContent.multiWordTexts[d.identity]=d;c={multiWordTexts:{}};c.multiWordTexts[d.identity]=boardContent.multiWordTexts[d.identity];Modes.select.setSelection(c);editor=d;c=b.byOrdinal(0);b.mousedownHandler(c);b.mouseupHandler(c);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=
boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);c();t.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});
Modes.select.clearSelection();blit()}}}(),video:function(){var b={},g=void 0,f=void 0,p=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();f.unwrap()},k=function(a){if(void 0!=b&&void 0!=b.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var c=new FileReader;c.onload=function(c){var d=$("<video/>"),f=d[0],g=c.target.result;f.addEventListener("loadeddata",function(c){c=f.videoHeight;
b.width=f.videoWidth;b.height=c;b.video=d;b.videoSrc=g;a()},!1);d.append($("<source />",{src:g,type:"video/mp4"}));d.load()};c.readAsDataURL(b.fileUpload)}},m=function(){if("imageDefinition"==b.type){WorkQueue.pause();var a=Date.now(),c=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){var f=$(c).find("resourceUrl").text(),g={type:"video",author:UserSettings.getUsername(),
timestamp:a,identity:f,slide:d.toString(),source:$(c).text(),bounds:[b.x,b.y,b.x+b.width,b.y+b.height],width:b.width,height:b.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:b.x,y:b.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),b=g.x,c=g.y,d=Math.max(g.width,viewboxWidth),e=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,e+2*a);Modes.select.clearSelection();Modes.select.selected.videos[g.identity]=boardContent.videos[g.identity];
Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);p();WorkQueue.gracefullyResume()},error:function(a){console.log(a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:b.videoSrc,cache:!1,contentType:!1,processData:!1})}},a=!1;$(function(){a||(a=!0,g=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),
f=$("#videoFileChoice").attr("accept","video/mp4"),f[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(b.fileUpload=a);k(m)},!1),p())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;d("#videoTools","#videoMode");var a=screenToWorld(10,10);b={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");g.show()},deactivate:function(){p();c()}}}(),image:function(){var b=
{},g=void 0,f=void 0,p=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();f.unwrap()},k=function(){var a=function(a,b,c,e){for(var d=b*c;d>a;)b*=.8,c*=.8,d=b*c;return{w:b,h:c,q:e}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,c){return a(1*d,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*d,
b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,d=1048576,f=function(){_.forEach(b,function(a){var b=$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){c=a;f()})});f()});return{reapplyVisualStyle:f,changeMode:function(a){a in b&&(c=b[a],f())},getResizeFunction:function(){return c.resizeFunc}}}(),m=function(c,d){var f=void 0==d?b:d;if(void 0==f||void 0==f.fileUpload||void 0==
c)console.log("returning because currentImage is empty",b);else{$("#imageWorking").show();$("#imageFileChoice").hide();var g=new FileReader;g.onload=function(b){var d=b.target.result;a(d,f,c,function(a){return d.length<a})};g.readAsDataURL(f.fileUpload)}},a=function(a,c,d,f){var g=void 0!=c?c:b,p=$("<canvas/>"),l=new Image;l.setAttribute("crossOrigin","Anonymous");l.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly across into MeTL.  You may need to download the image first and then upload it.")};
l.onload=function(b){var c=l.width,h=l.height,q=k.getResizeFunction()(c,h);b=q.w;var n=q.h,q=q.q;p.width=c;p.height=h;p.attr("width",c);p.attr("height",h);p.css({width:px(c),height:px(h)});var m=p[0].getContext("2d");m.rect(0,0,c,h);m.fillStyle="white";m.fill();m.drawImage(l,0,0,c,h);c=multiStageRescale(p[0],b,n);g.width=b;g.height=n;g.resizedImage=c.toDataURL("image/jpeg",q);f(g.resizedImage.length)&&(g.resizedImage=a);d(g)};l.src=a},n=function(a){if("imageDefinition"==a.type){WorkQueue.pause();
var b=Date.now(),c=sprintf("%s%s%s",UserSettings.getUsername(),b,_.uniqueId()),d=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){var f=$(c).find("resourceUrl").text(),l={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+f+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:f,slide:d.toString(),
source:$(c).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:a.x,y:a.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),b=l.x,c=l.y,d=Math.max(l.width,viewboxWidth),f=Math.max(l.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,f+2*a);Modes.select.clearSelection();Modes.select.selected.images[l.identity]=boardContent.images[l.identity];Progress.call("onSelectionChanged",
[Modes.select.selected])});sendStanza(l);p();WorkQueue.gracefullyResume()},error:function(a){console.log(a);p();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},v=!1;$(function(){v||(v=!0,g=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),
f=$("#imageFileChoice").attr("accept","image/*"),f[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("image")&&(b.fileUpload=a);m(n)},!1),p())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;d("#imageTools","#imageMode");var a=screenToWorld(10,10);b={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");k.reapplyVisualStyle();g.show()},handleDroppedSrc:function(b,c,d){var f=
screenToWorld(c,d);a(b,{type:"imageDefinition",screenX:c,screenY:d,x:f.x,y:f.y},n,function(a){return!1})},handleDrop:function(a,b,c){var d=0,f=[],g=function(a,g){if(null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(f,function(b){return b==a})){var e=screenToWorld(b,c+d),e={type:"imageDefinition",screenX:b,screenY:c+d,x:e.x,y:e.y};e.fileUpload=a;console.log("handlingDrop",a,g,e);f.push(a);m(n,e);d+=50}};_.forEach(a.files,function(a){g(a,"file")});_.forEach(a.items,function(a){a=a.getAsFile(0);
g(a,"item")})},deactivate:function(){p();c()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,c;registerPositionHandlers(board,function(d,g,k){takeControlOfViewbox();b=d;c=g},function(d,g,k){Pan.translate(-1*(d-b),-1*(g-c));b=d;c=g},function(b,c,d){})},deactivate:function(){c();unregisterPositionHandlers(board)}},select:function(){var b=!1,g=function(){Modes.select.selected={images:{},text:{},inks:{},
multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},f=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var d=Modes.select.selected[c];_.forEach(d,function(f){d&&b in boardContent&&f&&f.identity in boardContent[b]?d[f.identity]=boardContent[b][f.identity]:(a=!0,"inks"==c?"highlighters"==
b&&f.identity in d&&1==d[f.identity].isHighlighter?delete d[f.identity]:"inks"==b&&f.identity in d&&0==d[f.identity].isHighlighter&&delete d[f.identity]:delete d[f.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),p=function(){if(void 0!=Modes.select.selected&&b&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}g()},
k=function(){(b=Conversations.shouldModifyConversation()?!b:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");g()},m=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());
b?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=f;Progress.onViewboxChanged.ModesSelect=f;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),
b?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=
function(a){b&&!Conversations.shouldModifyConversation(a)&&(b=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",k),$("#ban").unbind("click").bind("click",p)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));m(a)};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=
scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,
b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var a={x:0,y:0},c=$("<div/>",{id:"selectMarquee"}),f=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!b){var a=batchTransform();a.isDeleted=
!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);g()}});var p=function(a){a("images");a("texts");a("multiWordTexts");
a("inks");a("videos")};Modes.select.dragging=!1;m();Modes.select.resizing=!1;registerPositionHandlers(board,function(b,d,g,p,m){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:b,y:d};Modes.select.marqueeWorldOrigin=p;if(!m.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){g=3/scale();var l=[p.x-g,p.y-g,p.x+g,p.y+g];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,
l):!1})})}console.log(b,d,p,Modes.select.dragging);Modes.select.dragging?(Modes.select.offset=p,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(f.empty(),f.append(c),c.show(),updateMarquee(c,a,a))},function(b,d,f,g,p){b={x:b,y:d};Modes.select.offset=g;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(c,a,b)},function(a,d,f,g,m){WorkQueue.gracefullyResume();try{var l=g.x-Modes.select.marqueeWorldOrigin.x,k=g.y-Modes.select.marqueeWorldOrigin.y;
15>Math.abs(l)+Math.abs(k)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=l;a.doc.position.y+=k;a.doc.invalidateBounds()});var e=batchTransform();e.xTranslate=l;e.yTranslate=k;e.inkIds=_.keys(Modes.select.selected.inks);e.textIds=_.keys(Modes.select.selected.texts);e.imageIds=_.keys(Modes.select.selected.images);
e.videoIds=_.keys(Modes.select.selected.videos);e.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(e.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(e)}else{var h=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),r=[h.left,h.top,h.right,h.bottom],w={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},B={},v={};p(function(a){$.each(boardContent[a],function(c,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);
break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(r,d.bounds)&&(incrementKey(B,d.author),incrementKey(v,"any"),b?d.author!=UserSettings.getUsername()&&(w[a][d.identity]=d):d.author==UserSettings.getUsername()&&(w[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,c){intersectRect(c.bounds,r)&&(incrementKey(B,c.author),b?c.author!=UserSettings.getUsername()&&(w.inks[c.identity]=
c):c.author==UserSettings.getUsername()&&(w.inks[c.identity]=c))});p(function(a){$.each(w[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});v.any||Modes.select.clearSelection();var C=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,
_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(B,function(a,b){C+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}c.css({width:0,height:0}).hide();blit()}catch(D){console.log("Selection up",D)}})},deactivate:function(){unregisterPositionHandlers(board);c();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();m();blit();blit()}}}(),zoom:{name:"zoom",
activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),c,f={x:0,y:0};registerPositionHandlers(board,function(d,g,m,a){takeControlOfViewbox();c=a;b.show();b.appendTo($("#selectionAdorner"));f={x:d,y:g};updateMarquee(b,f,f)},function(c,d,g,a){c={x:c,y:d};d=rectFromTwoPoints(c,f);g="left";a="top";c.x==d.left&&(g="right");c.y==d.top&&(a="bottom");c=aspectConstrainedRect(d,g,a);updateMarquee(b,{x:c.right,y:c.bottom},
{x:c.left,y:c.top})},function(d,f,g,a){WorkQueue.gracefullyResume();b.hide();d={x:contentOffsetX+a.x,y:contentOffsetY+a.y};f=rectFromTwoPoints(d,{x:contentOffsetX+c.x,y:contentOffsetY+c.y});2500>scale()*f.width*f.height||(g="left",a="top",d.x==f.left&&(g="right"),d.y==f.top&&(a="bottom"),d=aspectConstrainedRect(f,g,a),IncludeView.specific(d.left,d.top,d.width,d.height))})},deactivate:function(){c();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var b=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);
break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){b()};Progress.conversationDetailsReceived.respectNewPermissions=b;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;b();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,c,d,g){},function(b,c,d,g){},function(b,c,d,g){});b()},deactivate:function(){c();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),
draw:function(){var b=Brushes.getDefaultBrushes(),g=_.map(b,function(a){return _.clone(a)}),f,k=!1,w=void 0,m=void 0,a=function(a){g[a.index]=a},n=function(){},v=function(){},t=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var c=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,c){var h=g[c],l=$(b).css({color:h.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=h;a(h);Modes.draw.drawingAttributes=
f;k=!1;d(h)}).removeClass("fa-tint").removeClass("fa-circle").addClass(h.isHighlighter?"fa-circle":"fa-tint");l.find(".widthIndicator").text(h.width);h==f&&l.addClass("activeBrush")})},d=function(b){var g=$("#colors .dots"),e=$("#sizes .dots"),h=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();e.empty();k.map(function(g){var h=w.clone();e.append(h);h.click(function(){b.width=g;a(b);f=b;c();d(b)});var k=Canvas.circle(b.color,g,50);g==b.width&&h.addClass("activeTool");h.prepend(k);k=g.toString()+
"px";h.find(".sizeDotName").append(k)});g.empty();h.map(function(e){var h=m.clone();g.append(h);h.on("click",function(){b.color=e.rgb;f=b;a(b);c();d(b)});h.css("color",e.rgb);"rgb"in e&&e.rgb==b.color&&h.addClass("activeTool");var k=e.name;h.find(".colorDotName").append(k)});h=$("#setPenToHighlighter").unbind("click").on("click",function(){b.isHighlighter=!0;f=b;a(b);c();d(b)});k=$("#setPenToPen").unbind("click").on("click",function(){b.isHighlighter=!1;f=b;a(b);c();d(b)});"isHighlighter"in f&&f.isHighlighter?
(h.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):(k.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(b,function(a){return a.id==f.id});void 0!=a&&(f.width=a.width,f.color=a.color,f.isHighlighter=a.isHighlighter,c(),d(f))});w=$("#penSize .sizeDot").clone();m=$("#penColor .colorDot").clone();f=g[0];c();d(f);var x=$("#drawTools");
x.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");k=!0;$("#drawDropdowns").hide()});x.find(".advancedTools").unbind("click").on("click",function(){k||(d(f),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var u=[];v=function(a,b,c,d,f){y=[];k||f.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?
.4:1,u=[a,b,256*c])};var y=[];t=function(a,b,c,d,f){if(k||f.eraser){var g=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,g)){delete a[c.identity];y.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);a(boardContent.highlighters);boardContext.globalAlpha=
1}else d=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=d,d=_.takeRight(u,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),u=u.concat([a,b,256*c])};n=function(a,b,c,d,f){k||f.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=y,sendStanza(a)):(d=Modes.draw.drawingAttributes.width*c,boardContext.lineWidth=d,boardContext.beginPath(),boardContext.lineWidth=d,boardContext.lineCap="round",d=_.takeRight(u,
3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),u=u.concat([a,b,256*c]),strokeCollected(u));boardContext.globalAlpha=1}});return{name:"draw",brushes:g,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=f,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),k?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),
function(a,b){b+1==f.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,v,t,n))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();c();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,c,d,g){},function(b,c,d,g){},function(b,
c,d,g){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
